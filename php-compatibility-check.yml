name: PHP Compatibility Check

on:
  workflow_call:
    inputs:
      php-version:
        required: true
        type: string

env:
  PHP_VERSION: "5.4"

jobs:
  php-compatibility-check: # "runner" (un'istanza virtuale di macchina)
    name: "Check compatibility with PHP ${{ env.PHP_VERSION }}"
    runs-on: ubuntu-latest
    steps: # tutti gli step saranno eseguiti nella stessa istanza virtuale
      - name: Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2 # "setup-php" √® un'azione di GitHub che permette di installare versioni specifiche di PHP
        with:
          php-version: ${{ env.PHP_VERSION }} # versione di PHP da installare

      - name: Check PHP version
        run: |
          bash --version
          php -v
          if php -v | grep -q "PHP $PHP_VERSION"; then
            echo "‚úì PHP $PHP_VERSION is installed"
          else
            echo "‚ùå PHP $PHP_VERSION not installed"
            exit 1
          fi
          

      - name: About PHP ${{ env.PHP_VERSION }}
        run: echo "üêò PHP $PHP_VERSION is so old, it probably still thinks the internet is a fad!"

      - name: Checkout repository
        uses: actions/checkout@v4
    

      - name: Run PHP Syntax Check for ACM Files
        run: |
          find_syntax_mistake=0

          git fetch origin
          files=$(git diff origin/main --name-only --diff-filter=ACM | grep '\.php$' || true)

          # Controlla se files √® vuoto
          if [ -z "$files" ]; then
            echo "‚úÖ No PHP files to check. Everything is OK!"
            echo "Check if all pr files are in the list above (used for check compatibility)."
            git diff origin/main --name-only
            exit 0
          else
            echo "Found PHP files to check:"
            echo "$files"
          fi

          for file in $files; do
            error_file=$(php -l "$file")
            if ! echo "$error_file" | grep -q "No syntax errors"; then
              echo "‚ö†Ô∏è found error - path: $file"
              echo "log: $error_file"
              find_syntax_mistake=1
            else
              echo "No syntax errors in $file"
            fi
          done

          if [ "$find_syntax_mistake" -eq 1 ]; then
            echo "üîç Checked $(echo "$files" | wc -l) PHP files."
            echo "‚ùå Found Compatibility Error. Solve them before merging."
            echo "TIP 1: Check if you have spaces in file .php name."
            echo "TIP 2: Code might works but is not compatible with PHP $PHP_VERSION"
            echo "TIP 3: Check if all edited/added files are in the list above (used for check compatibility)."
            echo "TIP 4: Check if you are using PHP $PHP_VERSION."
            git diff origin/main --name-only --diff-filter=ACM | grep '\.php$'
            exit 1
          else
            echo "‚úÖ No syntax errors found in any PHP files."
            exit 0
          fi
